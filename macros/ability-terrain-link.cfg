#textdomain wesnoth-War_of_Legends

#define ABILITY_TERRAIN_LINK
    [dummy]
        id=WOL_terrain_link
        name= _ "terrain link"

        description= _ "This unit mutates depending on the terrain you're moving on."
        apply_to=self
    [/dummy]

    #ifdef __UNUSED__
        # wmlxgettext: [abilities]
        [/abilities]
        [event]
            name=side turn
            first_time_only=no

            [store_locations]
                [filter]
                    ability=terrain_link
                [/filter]
                variable=hex_moved_on
            [/store_locations]

            [while]
                [variable]
                    name=j
                    less_than=$hex_moved_on.length
                [/variable]
                [do]
                    [store_unit]
                        [filter]
                            x=$hex_moved_on[$j].x
                            y=$hex_moved_on[$j].y
                        [/filter]
                        variable=unit_to_modify
                        mode=append
                    [/store_unit]
                    [set_variable]
                        name=j
                        add=1
                    [/set_variable]
                [/do]
            [/while]
            {CLEAR_VARIABLE j}

            [while]
                [variable]
                    name=i
                    less_than=$hex_moved_on.length
                [/variable]
                [do]
                    # set the variable terrain_moved_on to forest,earth,water,air,desert or snow depending on the terrain the unit moved on.
                                                            [if]
                                                                [variable]
                                                                    name=hex_moved_on[$i].terrain
                                                                    contains=A
                                                                [/variable]
                                                                [or]
                                                                    [variable]
                                                                        name=hex_moved_on[$i].terrain
                                                                        contains=Ha
                                                                    [/variable]
                                                                    [or]
                                                                        [variable]
                                                                            name=hex_moved_on[$i].terrain
                                                                            contains=Ms
                                                                        [/variable]
                                                                    [/or]
                                                                [/or]
                                                                [then]
                                                                    [set_variable]
                                                                        name=terrain_moved_on
                                                                        value=snow
                                                                    [/set_variable]
                                                                [/then]
                                                                [else]
                    [if]
                        [variable]
                            name=hex_moved_on[$i].terrain
                            contains=F
                        [/variable]
                        [or]
                            [variable]
                                name=hex_moved_on[$i].terrain
                                contains=Uf
                            [/variable]
                        [/or]
                        [then]
                            [set_variable]
                                name=terrain_moved_on
                                value=forest
                            [/set_variable]
                        [/then]
                        [else]
                            [if]
                                [variable]
                                    name=hex_moved_on[$i].terrain
                                    contains=K
                                [/variable]
                                [or]
                                    [variable]
                                        name=hex_moved_on[$i].terrain
                                        contains=C
                                    [/variable]
                                [/or]
                                [then]
                                    [set_variable]
                                        name=terrain_moved_on
                                        value=air
                                    [/set_variable]
                                [/then]
                                [else]
                                    [if]
                                        [variable]
                                            name=hex_moved_on[$i].terrain
                                            contains=W
                                        [/variable]
                                        [or]
                                            [variable]
                                                name=hex_moved_on[$i].terrain
                                                contains=w
                                            [/variable]
                                        [/or]
                                        [then]
                                            [set_variable]
                                                name=terrain_moved_on
                                                value=water
                                            [/set_variable]
                                        [/then]
                                        [else]
                                            [if]
                                                [variable]
                                                    name=hex_moved_on[$i].terrain
                                                    equals=Ss^Vm
                                                [/variable]
                                                [or]
                                                    [variable]
                                                        name=hex_moved_on[$i].terrain
                                                        equals=Ss
                                                    [/variable]
                                                [/or]
                                                [then]
                                                    [set_variable]
                                                        name=terrain_moved_on
                                                        value=swamp
                                                    [/set_variable]
                                                [/then]
                                                [else]
                                                    [if]
                                                        [variable]
                                                            name=hex_moved_on[$i].terrain
                                                            equals=Hd
                                                        [/variable]
                                                        [or]
                                                            [variable]
                                                                name=hex_moved_on[$i].terrain
                                                                contains=D
                                                            [/variable]
                                                            [and]
                                                                [not]
                                                                    [variable]
                                                                        name=hex_moved_on[$i].terrain
                                                                        equals=Dd^Dr
                                                                    [/variable]
                                                                [/not]
                                                            [/and]
                                                        [/or]
                                                        [then]
                                                            [set_variable]
                                                                name=terrain_moved_on
                                                                value=desert
                                                            [/set_variable]
                                                        [/then]
                                                        [else]
                                                                    [if]
                                                                        [variable]
                                                                            name=hex_moved_on[$i].terrain
                                                                            equals=Dd^Dr
                                                                        [/variable]
                                                                        [or]
                                                                            [variable]
                                                                                name=hex_moved_on[$i].terrain
                                                                                contains=H
                                                                            [/variable]
                                                                            [or]
                                                                                [variable]
                                                                                    name=hex_moved_on[$i].terrain
                                                                                    contains=M
                                                                                [/variable]
                                                                                [or]
                                                                                    [variable]
                                                                                        name=hex_moved_on[$i].terrain
                                                                                        contains=U
                                                                                    [/variable]
                                                                                [/or]
                                                                            [/or]
                                                                        [/or]
                                                                        [then]
                                                                            [set_variable]
                                                                                name=terrain_moved_on
                                                                                value=earth
                                                                            [/set_variable]
                                                                        [/then]
                                                                        [else]
                                                                            [set_variable]
                                                                                name=terrain_moved_on
                                                                                value=air
                                                                            [/set_variable]
                                                                        [/else]
                                                                    [/if]
                                                        [/else]
                                                    [/if]
                                                [/else]
                                            [/if]
                                        [/else]
                                    [/if]
                                [/else]
                            [/if]
                        [/else]
                    [/if]
                                                                [/else]
                                                            [/if]

                    # mutates the unit according to the terrain
                    [switch]
                        variable=terrain_moved_on
                        [case]
                            value=forest
                            [object]
                                silent=yes
                                [filter]
                                    x=$hex_moved_on[$i].x
                                    y=$hex_moved_on[$i].y
                                [/filter]
                                [effect]
                                    apply_to=variation
                                    name=unstable_bramble_form
                                [/effect]
                            [/object]
                        [/case]
                        [case]
                            value=earth
                            [object]
                                silent=yes
                                [filter]
                                    x=$hex_moved_on[$i].x
                                    y=$hex_moved_on[$i].y
                                [/filter]
                                [effect]
                                    apply_to=variation
                                    name=unstable_quake_form
                                [/effect]
                            [/object]
                        [/case]
                        [case]
                            value=water
                            [object]
                                silent=yes
                                [filter]
                                    x=$hex_moved_on[$i].x
                                    y=$hex_moved_on[$i].y
                                [/filter]
                                [effect]
                                    apply_to=variation
                                    name=unstable_whirlpool_form
                                [/effect]
                            [/object]
                        [/case]
                        [case]
                            value=swamp
                            [object]
                                silent=yes
                                [filter]
                                    x=$hex_moved_on[$i].x
                                    y=$hex_moved_on[$i].y
                                [/filter]
                                [effect]
                                    apply_to=variation
                                    name=unstable_whirlpool_form-swamp
                                [/effect]
                            [/object]
                        [/case]
                        [case]
                            value=desert
                            [object]
                                silent=yes
                                [filter]
                                    x=$hex_moved_on[$i].x
                                    y=$hex_moved_on[$i].y
                                [/filter]
                                [effect]
                                    apply_to=variation
                                    name=unstable_sandstorm_form
                                [/effect]
                            [/object]
                        [/case]
                        [case]
                            value=snow
                            [object]
                                silent=yes
                                [filter]
                                    x=$hex_moved_on[$i].x
                                    y=$hex_moved_on[$i].y
                                [/filter]
                                [effect]
                                    apply_to=variation
                                    name=unstable_frost_form
                                [/effect]
                            [/object]
                        [/case]
                        [else]
                            [object]
                                silent=yes
                                [filter]
                                    x=$hex_moved_on[$i].x
                                    y=$hex_moved_on[$i].y
                                [/filter]
                                [effect]
                                    apply_to=variation
                                    name=unstable_tornado_form
                                [/effect]
                            [/object]
                        [/else]
                    [/switch]

                    [store_unit]
                        [filter]
                            x=$hex_moved_on[$i].x
                            y=$hex_moved_on[$i].y
                        [/filter]
                        variable=unit_modified
                    [/store_unit]
                    [set_variable]
                        name=unit_modified.hitpoints
                        value=$unit_to_modify[$i].hitpoints
                    [/set_variable]
                    [set_variables]
                        name=unit_modified.status
                        to_variable=unit_to_modify[$i].status
                    [/set_variables]
                    [set_variables]
                        name=unit_modified.variables
                        to_variable=unit_to_modify[$i].variables
                    [/set_variables]
                    [unstore_unit]
                        variable=unit_modified
                    [/unstore_unit]

                    [set_variable]
                        name=i
                        add=1
                    [/set_variable]

                    {CLEAR_VARIABLE unit_modified}
                [/do]
            [/while]
            {CLEAR_VARIABLE i}

            {CLEAR_VARIABLE hex_moved_on}
            {CLEAR_VARIABLE unit_to_modify}
        [/event]
        # This following code prevents glitch of the whirlpool color
        # when standing animation is turned off.
        [event]
            name=attack end
            first_time_only=no
            [filter]
                ability=terrain_link
                [filter_wml]
                    variation=unstable_whirlpool_form-swamp
                [/filter_wml]
            [/filter]
            [store_locations]
                x,y=$unit.x,$unit.y
                terrain=*W*,*w*
                variable=match
            [/store_locations]
            {FOREACH match i}
                [object]
                    silent=yes
                    [filter]
                        x=$match[$i].x
                        y=$match[$i].y
                    [/filter]
                    [effect]
                        apply_to=variation
                        name=unstable_whirlpool_form
                    [/effect]
                [/object]
                [store_unit]
                    [filter]
                        x=$match[$i].x
                        y=$match[$i].y
                    [/filter]
                    variable=unit_modified
                [/store_unit]
                [set_variable]
                    name=unit_modified.hitpoints
                    value=$unit.hitpoints
                [/set_variable]
                [set_variables]
                    name=unit_modified.status
                    to_variable=unit.status
                [/set_variables]
                [set_variables]
                    name=unit_modified.variables
                    to_variable=unit.variables
                [/set_variables]
                [unstore_unit]
                    variable=unit_modified
                [/unstore_unit]
            {NEXT i}
        [/event]
        [event]
            name=attack end
            first_time_only=no
            [filter]
                ability=terrain_link
                [filter_wml]
                    variation=unstable_whirlpool_form
                [/filter_wml]
            [/filter]
            [store_locations]
                x,y=$unit.x,$unit.y
                terrain=Ss*
                variable=match
            [/store_locations]
            {FOREACH match i}
                [object]
                    silent=yes
                    [filter]
                        x=$match[$i].x
                        y=$match[$i].y
                    [/filter]
                    [effect]
                        apply_to=variation
                        name=unstable_whirlpool_form-swamp
                    [/effect]
                [/object]
                [store_unit]
                    [filter]
                        x=$match[$i].x
                        y=$match[$i].y
                    [/filter]
                    variable=unit_modified
                [/store_unit]
                [set_variable]
                    name=unit_modified.hitpoints
                    value=$unit.hitpoints
                [/set_variable]
                [set_variables]
                    name=unit_modified.status
                    to_variable=unit.status
                [/set_variables]
                [set_variables]
                    name=unit_modified.variables
                    to_variable=unit.variables
                [/set_variables]
                [unstore_unit]
                    variable=unit_modified
                [/unstore_unit]
            {NEXT i}
        [/event]
    #endif

#enddef

#define NOTE_TERRAIN_LINK
    [special_note]
        note=_" That unit mutates depending on the terrain she is moving to, taking a form that result in better defense and movement."
    [/special_note]
#enddef
